{% extends "base.html" %}
{% load static %}

{% block title %}Registro de Ubicaci√≥n{% endblock %}

{% block extra_css %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<!-- Leaflet JavaScript -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Verificaci√≥n de carga -->
<script>
console.log('üçÉ Verificando carga de Leaflet...');

document.addEventListener('DOMContentLoaded', function() {
    setTimeout(function() {
        if (typeof L !== 'undefined') {
            console.log('‚úÖ Leaflet cargado exitosamente! Versi√≥n:', L.version);
            window.leafletLoaded = true;
        } else {
            console.warn('‚ö†Ô∏è Leaflet no se carg√≥, marcando como fallido');
            window.leafletLoadFailed = true;
        }
    }, 1000);
});

// Funci√≥n para mostrar informaci√≥n de registros anteriores
window.mostrarMapaRegistro = function(lat, lng, accuracy, timestamp, tipo) {
    console.log('üó∫Ô∏è Mostrando ubicaci√≥n de registro:', tipo);
    
    // Convertir par√°metros a n√∫meros
    const latNum = parseFloat(lat);
    const lngNum = parseFloat(lng);
    
    // Validar que los par√°metros sean correctos
    if (isNaN(latNum) || isNaN(lngNum)) {
        console.error('‚ùå Coordenadas inv√°lidas:', lat, lng);
        return;
    }
    
    // Mostrar informaci√≥n inmediatamente
    initMap(latNum, lngNum, accuracy, timestamp, tipo);
    
    // Scroll hacia la informaci√≥n
    setTimeout(() => {
        const mapContainer = document.getElementById('mapContainer');
        if (mapContainer) {
            mapContainer.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center' 
            });
        }
    }, 100);
};

// Funci√≥n para inicializar el mapa
function initMap(lat, lng, accuracy, timestamp, tipo) {
    // Convertir par√°metros a n√∫meros
    const latNum = parseFloat(lat);
    const lngNum = parseFloat(lng);
    
    console.log('üìç Mostrando ubicaci√≥n:', latNum.toFixed(6), lngNum.toFixed(6));
    
    // Verificaci√≥n r√°pida de Leaflet - sin esperas
    if (typeof L !== 'undefined') {
        console.log('üó∫Ô∏è Creando mapa interactivo');
        createMap(latNum, lngNum, accuracy, timestamp, tipo);
    } else {
        console.log('üìã Usando vista de informaci√≥n');
        mostrarInfoSinMapa(latNum, lngNum, accuracy, timestamp, tipo);
    }
}

// Funci√≥n separada para crear el mapa
function createMap(lat, lng, accuracy, timestamp, tipo) {
    console.log('üó∫Ô∏è Creando mapa con Leaflet disponible');
    
    const mapContainer = document.getElementById('mapContainer');
    if (mapContainer) {
        mapContainer.innerHTML = '<div id="locationMap" style="height: 300px; border-radius: 8px;"></div>';
        mapContainer.classList.add('show');
    }
    
    setTimeout(() => {
        try {
            const map = L.map('locationMap').setView([lat, lng], 16);
            console.log('‚úÖ Mapa creado exitosamente');
            
            // Continuar con la configuraci√≥n
            setupMapLayers(lat, lng, accuracy, timestamp, tipo);
        } catch (error) {
            console.error('‚ùå Error al crear mapa:', error);
        }
    }, 100);
}

// Funci√≥n para configurar las capas del mapa
function setupMapLayers(lat, lng, accuracy, timestamp, tipo) {
    try {
        // Agregar tiles de OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);
        
        // Obtener descripci√≥n de precisi√≥n
        let precisionText = 'Media';
        if (accuracy <= 10) precisionText = 'Excelente';
        else if (accuracy <= 50) precisionText = 'Buena';
        else if (accuracy <= 100) precisionText = 'Media';
        else precisionText = 'Baja';
        
        // Agregar marcador
        L.marker([lat, lng]).addTo(map)
            .bindPopup(`
                <div class="text-center">
                    <strong>üìç ${tipo.charAt(0).toUpperCase() + tipo.slice(1)}</strong><br>
                    <small>
                        ${timestamp}<br>
                        Precisi√≥n: ${accuracy ? accuracy.toFixed(0) : '50'}m (${precisionText})
                    </small>
                </div>
            `).openPopup();
        
        // Actualizar informaci√≥n en la interfaz
        const latNum = parseFloat(lat);
        const lngNum = parseFloat(lng);
        document.getElementById('mapLatitude').textContent = latNum.toFixed(6);
        document.getElementById('mapLongitude').textContent = lngNum.toFixed(6);
        document.getElementById('mapPrecision').textContent = `${accuracy ? accuracy.toFixed(0) : '50'}m (${precisionText})`;
        document.getElementById('mapTimestamp').textContent = timestamp;
        
    } catch (error) {
        console.error('‚ùå Error al configurar capas del mapa:', error);
        mostrarInfoSinMapa(lat, lng, accuracy, timestamp, tipo);
    }
}

// Funci√≥n para mostrar informaci√≥n sin mapa cuando Leaflet falla
function mostrarInfoSinMapa(lat, lng, accuracy, timestamp, tipo) {
    console.log('üìã Mostrando informaci√≥n sin mapa interactivo');
    
    // Convertir par√°metros a n√∫meros si son strings
    const latNum = parseFloat(lat);
    const lngNum = parseFloat(lng);
    
    // Obtener descripci√≥n de precisi√≥n
    let precisionText = 'Media';
    if (accuracy <= 10) precisionText = 'Excelente';
    else if (accuracy <= 50) precisionText = 'Buena';
    else if (accuracy <= 100) precisionText = 'Media';
    else precisionText = 'Baja';
    
    const mapContainer = document.getElementById('mapContainer');
    if (mapContainer) {
        mapContainer.innerHTML = `
            <div class="location-card">
                <div class="row">
                    <div class="col-md-8">
                        <h5 class="mb-3">üìç Informaci√≥n de Ubicaci√≥n</h5>
                        
                        <div class="info-grid">
                            <div class="info-item">
                                <strong>üåê Latitud:</strong>
                                <span id="mapLatitude">${latNum.toFixed(6)}</span>
                            </div>
                            
                            <div class="info-item">
                                <strong>üåê Longitud:</strong>
                                <span id="mapLongitude">${lngNum.toFixed(6)}</span>
                            </div>
                            
                            <div class="info-item">
                                <strong>üéØ Precisi√≥n:</strong>
                                <span id="mapPrecision">${accuracy ? accuracy.toFixed(0) : '50'}m (${precisionText})</span>
                            </div>
                            
                            <div class="info-item">
                                <strong>‚è∞ Hora:</strong>
                                <span id="mapTimestamp">${timestamp}</span>
                            </div>
                            
                            <div class="info-item">
                                <strong>üìã Tipo:</strong>
                                <span>${tipo.charAt(0).toUpperCase() + tipo.slice(1)}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4 text-center">
                        <div class="map-placeholder">
                            <i class="fas fa-map-marked-alt fa-3x text-primary mb-2"></i>
                            <p class="text-muted small">Mapa no disponible</p>
                            
                            <a href="https://www.google.com/maps?q=${latNum},${lngNum}" 
                               target="_blank" 
                               class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-external-link-alt"></i>
                                Ver en Google Maps
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        `;
        mapContainer.classList.add('show');
    }
}
</script>

<style>
    .location-card {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        border: 1px solid #e3e6f0;
        margin-bottom: 20px;
    }
    
    .info-grid {
        display: grid;
        gap: 12px;
    }
    
    .info-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #f1f3f4;
    }
    
    .info-item:last-child {
        border-bottom: none;
    }
    
    .map-placeholder {
        background: #f8f9fc;
        border-radius: 8px;
        padding: 20px;
        border: 2px dashed #d1d3e2;
    }
    
    #mapContainer {
        opacity: 0;
        transition: opacity 0.3s ease;
        margin-top: 20px;
    }
    
    #mapContainer.show {
        opacity: 1;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">üìç Control de Asistencia</h1>
    </div>

    <div class="row">
        <div class="col-xl-8 col-lg-7">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-clock"></i> Registro de Asistencia
                    </h6>
                    <div class="badge badge-success">{{ empleado.nombre_completo }}</div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <button id="btnRegistrarEntrada" 
                                    class="btn btn-success btn-lg btn-block mb-3"
                                    onclick="confirmarRegistro('entrada')">
                                <i class="fas fa-sign-in-alt"></i>
                                <strong>ENTRADA</strong>
                                <small class="d-block">Registrar llegada</small>
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button id="btnRegistrarSalida" 
                                    class="btn btn-danger btn-lg btn-block mb-3"
                                    onclick="confirmarRegistro('salida')">
                                <i class="fas fa-sign-out-alt"></i>
                                <strong>SALIDA</strong>
                                <small class="d-block">Registrar salida</small>
                            </button>
                        </div>
                    </div>
                    
                    <div id="ubicacionInfo" class="alert alert-info" style="display: none;">
                        <i class="fas fa-spinner fa-spin"></i> Obteniendo ubicaci√≥n...
                    </div>
                    
                    <div id="statusMessage" class="mt-3"></div>
                </div>
            </div>
        </div>

        <div class="col-xl-4 col-lg-5">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-history"></i> Registros Recientes
                    </h6>
                </div>
                <div class="card-body">
                    {% if registros_recientes %}
                        {% for registro in registros_recientes %}
                        <div class="border-left-{{ registro.tipo|yesno:'success,danger' }} p-3 mb-3 bg-light">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong class="text-{{ registro.tipo|yesno:'success,danger' }}">
                                        <i class="fas fa-{{ registro.tipo|yesno:'sign-in-alt,sign-out-alt' }}"></i>
                                        {{ registro.get_tipo_display|upper }}
                                    </strong>
                                    <br>
                                    <small class="text-muted">
                                        {{ registro.fecha_local|date:"j M Y" }} - {{ registro.fecha_local|date:"H:i:s" }}
                                    </small>
                                </div>
                                <button class="btn btn-outline-primary btn-sm" 
                                        onclick="mostrarMapaRegistro('{{ registro.latitud }}', '{{ registro.longitud }}', {{ registro.precision|default:50 }}, '{{ registro.fecha_local|date:"H:i:s" }}', '{{ registro.get_tipo_display|lower }}')">
                                    <i class="fas fa-map-marker-alt"></i>
                                    Ver
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center text-muted">
                            <i class="fas fa-clock fa-2x mb-2"></i>
                            <p>No hay registros recientes</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Contenedor para mostrar informaci√≥n del mapa -->
    <div id="mapContainer" style="display: block;"></div>
</div>

<script>
console.log('üöÄ Control de Asistencia SOMA - Listo');

// Funci√≥n para confirmar y realizar el registro
function confirmarRegistro(tipo) {
    // Convertir par√°metros a n√∫meros desde el inicio
    const latNum = parseFloat('{{ ultimo_registro.latitud|default:"0" }}');
    const lngNum = parseFloat('{{ ultimo_registro.longitud|default:"0" }}');
    
    console.log('üéØ Confirmando registro de', tipo);
    
    if (!navigator.geolocation) {
        alert('‚ùå Tu navegador no soporta geolocalizaci√≥n');
        return;
    }

    const btnEntrada = document.getElementById('btnRegistrarEntrada');
    const btnSalida = document.getElementById('btnRegistrarSalida');
    const ubicacionInfo = document.getElementById('ubicacionInfo');
    
    // Deshabilitar botones mientras se procesa
    btnEntrada.disabled = true;
    btnSalida.disabled = true;
    ubicacionInfo.style.display = 'block';
    ubicacionInfo.innerHTML = '<i class="fas fa-spinner fa-spin"></i> üìç Obteniendo tu ubicaci√≥n...';

    navigator.geolocation.getCurrentPosition(
        function(position) {
            const coords = {
                latitude: position.coords.latitude,
                longitude: position.coords.longitude,
                accuracy: position.coords.accuracy
            };
            
            console.log('üìç Ubicaci√≥n obtenida:', coords);
            enviarRegistro(tipo, coords);
        },
        function(error) {
            console.error('‚ùå Error de geolocalizaci√≥n:', error);
            let mensaje = '‚ùå No se pudo obtener la ubicaci√≥n. ';
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    mensaje += 'Por favor, permite el acceso a tu ubicaci√≥n.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    mensaje += 'Tu ubicaci√≥n no est√° disponible.';
                    break;
                case error.TIMEOUT:
                    mensaje += 'Se agot√≥ el tiempo de espera.';
                    break;
            }
            
            ubicacionInfo.innerHTML = mensaje;
            ubicacionInfo.className = 'alert alert-danger';
            
            // Rehabilitar botones
            btnEntrada.disabled = false;
            btnSalida.disabled = false;
        },
        {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 60000
        }
    );
}

// Funci√≥n para enviar el registro al servidor
function enviarRegistro(tipo, coords) {
    const ubicacionInfo = document.getElementById('ubicacionInfo');
    
    ubicacionInfo.innerHTML = '<i class="fas fa-spinner fa-spin"></i> üíæ Guardando registro...';
    
    const formData = new FormData();
    formData.append('tipo', tipo);
    formData.append('latitud', coords.latitude);
    formData.append('longitud', coords.longitude);
    formData.append('precision', coords.accuracy);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

    fetch('{% url "ubicaciones:api_registrar" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => response.json())
    .then(data => {
        console.log('üì° Respuesta del servidor:', data);
        
        if (data.success) {
            ubicacionInfo.innerHTML = `
                <i class="fas fa-check-circle"></i> 
                <strong>‚úÖ ${data.message}</strong>
                <br><small>üìç Ubicaci√≥n: ${coords.latitude.toFixed(6)}, ${coords.longitude.toFixed(6)}</small>
                <br><small>üéØ Precisi√≥n: ${coords.accuracy.toFixed(0)}m</small>
            `;
            ubicacionInfo.className = 'alert alert-success';
            
            // Recargar la p√°gina despu√©s de 2 segundos para mostrar el nuevo registro
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            ubicacionInfo.innerHTML = '‚ùå ' + (data.message || 'Error al guardar el registro');
            ubicacionInfo.className = 'alert alert-danger';
        }
    })
    .catch(error => {
        console.error('‚ùå Error:', error);
        ubicacionInfo.innerHTML = '‚ùå Error de conexi√≥n. Por favor, intenta de nuevo.';
        ubicacionInfo.className = 'alert alert-danger';
    })
    .finally(() => {
        // Rehabilitar botones
        document.getElementById('btnRegistrarEntrada').disabled = false;
        document.getElementById('btnRegistrarSalida').disabled = false;
    });
}

// Inicializaci√≥n cuando el DOM est√° listo
document.addEventListener('DOMContentLoaded', function() {
    console.log('‚úÖ Sistema operativo');
    
    console.log('üîß Configurando event listeners...');
    
    const btnEntrada = document.getElementById('btnRegistrarEntrada');
    const btnSalida = document.getElementById('btnRegistrarSalida');
    
    console.log('üîç Bot√≥n entrada encontrado:', btnEntrada ? 'S√ç' : 'NO');
    console.log('üîç Bot√≥n salida encontrado:', btnSalida ? 'S√ç' : 'NO');
    
    if (btnEntrada) {
        btnEntrada.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('üü¢ Click en bot√≥n ENTRADA');
            confirmarRegistro('entrada');
        });
    }
    
    if (btnSalida) {
        btnSalida.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('üî¥ Click en bot√≥n SALIDA');
            confirmarRegistro('salida');
        });
    }
    
    console.log('üéØ Todos los event listeners configurados');
});
</script>
{% endblock %}
