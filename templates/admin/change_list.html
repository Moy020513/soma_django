{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_list %}

{# ========== ESTILOS ========== #}
{% block extrastyle %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static "admin/css/changelists.css" %}">
  {{ media.css }}
  <style>
    .changelist-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }

    .changelist-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      padding-bottom: 1.5rem;
      border-bottom: 3px solid #f3f4f6;
    }

    .changelist-header h1 {
      font-size: 2rem;
      font-weight: 700;
      color: #111827;
      margin: 0;
      letter-spacing: -0.025em;
    }

    .changelist-toolbar {
      background: #ffffff;
      padding: 1.25rem;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
      margin-bottom: 1.5rem;
    }

    .changelist-content {
      background: #ffffff;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
      overflow: hidden;
    }

    /* Por defecto algunos changelists usan table-layout fixed para layouts compactos.
       Para CTZ queremos que las columnas crezcan según el contenido más largo, así que
       anulamos a table-layout:auto más abajo para el modelo ctz. */
    #changelist table, #result_list, #changelist .results table {
      table-layout: fixed;
      width: 100%;
    }

    #changelist th, #changelist td, #result_list th, #result_list td {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    @media (max-width: 768px) {
      #changelist th, #changelist td, #result_list th, #result_list td {
        white-space: normal;
      }
    }

   /* Para CTZ: usar table-layout:auto y permitir que columnas crezcan según el contenido
     más largo. Usamos min-width en px para una base razonable pero permitimos expansión. */
   body.app-empresas.model-ctz #result_list table,
   body.app-empresas.model-ctz #result_list .results table {
    table-layout: auto !important;
   }
   body.app-empresas.model-ctz #result_list th.column-empresa { min-width: 220px; }
   body.app-empresas.model-ctz #result_list th.column-proveedor_display { min-width: 100px; }
   body.app-empresas.model-ctz #result_list th.column-mo_soma_display { min-width: 100px; }
   body.app-empresas.model-ctz #result_list th.column-otros_materiales_display { min-width: 100px; }
   body.app-empresas.model-ctz #result_list th.column-pu_display { min-width: 80px; }
   body.app-empresas.model-ctz #result_list th.column-porcentaje_pu_display { min-width: 90px; }
   body.app-empresas.model-ctz #result_list th.column-total_pu_display { min-width: 120px; }
   body.app-empresas.model-ctz #result_list th.column-fecha_creacion { min-width: 160px; }
   /* Asegurar que las celdas siguen la misma anchura mínima que los encabezados, pero
     que puedan crecer en caso de contenido más largo. */
   body.app-empresas.model-ctz #result_list td.column-empresa { min-width: 220px; }
   body.app-empresas.model-ctz #result_list td.column-proveedor_display { min-width: 100px; }
   body.app-empresas.model-ctz #result_list td.column-mo_soma_display { min-width: 100px; }
   body.app-empresas.model-ctz #result_list td.column-otros_materiales_display { min-width: 100px; }
   body.app-empresas.model-ctz #result_list td.column-pu_display { min-width: 80px; }
   body.app-empresas.model-ctz #result_list td.column-porcentaje_pu_display { min-width: 90px; }
   body.app-empresas.model-ctz #result_list td.column-total_pu_display { min-width: 120px; }
   body.app-empresas.model-ctz #result_list td.column-fecha_creacion { min-width: 160px; }

    .breadcrumbs {
      background: #f9fafb;
      padding: 1rem 2rem;
      border-bottom: 1px solid #e5e7eb;
      font-size: 0.9rem;
    }

    .breadcrumbs a {
      color: #059669;
      text-decoration: none;
      font-weight: 500;
      transition: color 0.2s;
    }

    .breadcrumbs a:hover {
      color: #047857;
      text-decoration: underline;
    }

    .object-tools {
      display: flex;
      gap: 0.75rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .object-tools a,
    .object-tools a.addlink,
    .object-tools a:link,
    .object-tools a:visited {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
      color: #ffffff !important;
      padding: 0.625rem 1.5rem;
      border-radius: 6px;
      font-weight: 600;
      font-size: 0.95rem;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.2s;
      box-shadow: 0 2px 4px rgba(16, 185, 129, 0.25);
    }

    .object-tools a:hover,
    .object-tools a.addlink:hover {
      transform: translateY(-2px) !important;
      box-shadow: 0 4px 8px rgba(16, 185, 129, 0.35) !important;
      background: linear-gradient(135deg, #059669 0%, #047857 100%) !important;
    }

    #changelist-filter {
      background: #f9fafb;
      border-radius: 6px;
      padding: 1rem;
    }

    #changelist table {
      border-collapse: separate;
      border-spacing: 0;
    }

    #changelist thead th {
      background: #f9fafb;
      font-weight: 600;
      color: #374151;
      padding: 1rem;
      border-bottom: 2px solid #e5e7eb;
    }

    #changelist tbody tr:hover {
      background: #f9fafb;
    }

    #changelist tbody td {
      padding: 0.875rem 1rem;
      border-bottom: 1px solid #f3f4f6;
    }
    /* Reglas adicionales para asegurar una única fila: forzar que los hijos sean inline
       y centrar verticalmente. Usamos selectors específicos y !important para sobreescribir
       estilos del admin que podrían usar elementos de bloque internos. */
    body.app-empresas.model-ctz #result_list th, 
    body.app-empresas.model-ctz #result_list td {
      white-space: nowrap !important;
      vertical-align: middle !important;
      text-align: left;
    }

    /* Centramos las columnas de PU, porcentaje y TOTAL PU; evitar que el símbolo y
       el número aparezcan en líneas separadas forzando que los hijos sean inline-block */
   body.app-empresas.model-ctz #result_list td.column-pu_display,
    body.app-empresas.model-ctz #result_list td.column-proveedor_display,
    body.app-empresas.model-ctz #result_list td.column-mo_soma_display,
    body.app-empresas.model-ctz #result_list td.column-otros_materiales_display,
    body.app-empresas.model-ctz #result_list td.column-total_pu_display,
    body.app-empresas.model-ctz #result_list td.column-porcentaje_pu_display,
    /* También apuntar a las clases 'field-*' que Django puede generar en el tbody */
    body.app-empresas.model-ctz #result_list td.field-pu_display,
    body.app-empresas.model-ctz #result_list td.field-proveedor_display,
    body.app-empresas.model-ctz #result_list td.field-mo_soma_display,
    body.app-empresas.model-ctz #result_list td.field-otros_materiales_display,
    body.app-empresas.model-ctz #result_list td.field-total_pu_display,
    body.app-empresas.model-ctz #result_list td.field-porcentaje_pu_display {
      text-align: center !important;
    }

  body.app-empresas.model-ctz #result_list td.column-pu_display > *,
    body.app-empresas.model-ctz #result_list td.column-proveedor_display > *,
    body.app-empresas.model-ctz #result_list td.column-mo_soma_display > *,
    body.app-empresas.model-ctz #result_list td.column-otros_materiales_display > *,
    body.app-empresas.model-ctz #result_list td.column-total_pu_display > *,
    body.app-empresas.model-ctz #result_list td.column-porcentaje_pu_display > *,
    /* hijos directos de 'field-*' */
    body.app-empresas.model-ctz #result_list td.field-pu_display > *,
    body.app-empresas.model-ctz #result_list td.field-proveedor_display > *,
    body.app-empresas.model-ctz #result_list td.field-mo_soma_display > *,
    body.app-empresas.model-ctz #result_list td.field-otros_materiales_display > *,
    body.app-empresas.model-ctz #result_list td.field-total_pu_display > *,
    body.app-empresas.model-ctz #result_list td.field-porcentaje_pu_display > * {
      display: inline-block !important;
      white-space: nowrap !important;
      vertical-align: middle !important;
    }

    /* Si el inline-block no es suficiente, forzamos layout flex en las celdas numéricas
       para que sus hijos se coloquen en una sola fila (alineados y con separación). */
    body.app-empresas.model-ctz #result_list td.column-pu_display,
    body.app-empresas.model-ctz #result_list td.column-proveedor_display,
    body.app-empresas.model-ctz #result_list td.column-mo_soma_display,
    body.app-empresas.model-ctz #result_list td.column-otros_materiales_display,
    body.app-empresas.model-ctz #result_list td.column-total_pu_display,
    body.app-empresas.model-ctz #result_list td.column-porcentaje_pu_display,
    body.app-empresas.model-ctz #result_list td.field-pu_display,
    body.app-empresas.model-ctz #result_list td.field-proveedor_display,
    body.app-empresas.model-ctz #result_list td.field-mo_soma_display,
    body.app-empresas.model-ctz #result_list td.field-otros_materiales_display,
    body.app-empresas.model-ctz #result_list td.field-total_pu_display,
    body.app-empresas.model-ctz #result_list td.field-porcentaje_pu_display {
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      gap: 6px;
    }

    /* Si hay enlaces (empresa), asegurar que el link no haga wrap interno */
    body.app-empresas.model-ctz #result_list td.column-empresa a {
      display: inline-block !important;
      white-space: nowrap !important;
      vertical-align: middle !important;
    }
  </style>
{% endblock %}

{# ========== SCRIPTS ========== #}
{% block extrahead %}
  {{ block.super }}
  {{ media.js }}
{% endblock %}

{# ========== CLASES BODY ========== #}
{% block bodyclass %}
  {{ block.super }} app-{{ opts.app_label }} model-{{ opts.model_name }} change-list
{% endblock %}

{# ========== BREADCRUMBS ========== #}
{% block breadcrumbs %}
  <div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">{% translate 'Inicio' %}</a>
    &rsaquo; 
    <a href="{% url 'admin:app_list' app_label=cl.opts.app_label %}">
      {{ cl.opts.app_config.verbose_name }}
    </a>
    &rsaquo; 
    {{ cl.opts.verbose_name_plural|capfirst }}
  </div>
{% endblock %}

{% block coltype %}{% endblock %}

{# ========== CONTENIDO PRINCIPAL ========== #}
{% block content %}
  <div class="changelist-container">
    {# Mostrar mensajes flash también en la vista de listado (changelist) para cada módulo #}
    {% include 'partials/messages.html' %}
    
    {# Encabezado con título #}
    <div class="changelist-header">
      <h1>{{ cl.opts.verbose_name_plural|capfirst }}</h1>
      
      {# Herramientas de objetos #}
      {% block object-tools %}
        <div class="object-tools">
          {% change_list_object_tools %}
        </div>
      {% endblock %}
    </div>

    {# Contenido del changelist #}
    <div class="changelist-content">
      {% include "admin/change_list_htmx.html" %}
    </div>

  </div>
{% endblock %}