{% extends "admin/change_form.html" %}
{% load static %}

{% block extrahead %}
{{ block.super }}
<style>
  .empleado-form-row { margin-bottom: 10px; }
</style>
{% endblock %}

{% block after_field_sets %}
  <h3>Empleados asignados</h3>
  <div id="empleados-formset">
    {% for form in empleados_formset.forms %}
      <div class="empleado-form-row">
        {{ form.empleado }}
        <button type="button" class="remove-empleado btn btn-danger btn-sm">Eliminar</button>
      </div>
    {% endfor %}
  </div>
  <div id="empleado-empty-form" style="display:none;">
    <div class="empleado-form-row">
      <label for="id_empleados-__prefix__-empleado">Empleado:</label>
      <select name="empleados-__prefix__-empleado" id="id_empleados-__prefix__-empleado">
        {% for emp in empleados_formset.forms.0.fields.empleado.queryset %}
          <option value="{{ emp.pk }}">{{ emp }}</option>
        {% endfor %}
      </select>
      <button type="button" class="remove-empleado btn btn-danger btn-sm">Eliminar</button>
    </div>
  </div>
  <button type="button" id="add-empleado" class="btn btn-success btn-sm">Agregar otro empleado</button>
  <input type="hidden" name="empleados-TOTAL_FORMS" id="id_empleados-TOTAL_FORMS" value="{{ empleados_formset.total_form_count }}">
  <input type="hidden" name="empleados-INITIAL_FORMS" value="{{ empleados_formset.initial_form_count }}">
  <input type="hidden" name="empleados-MIN_NUM_FORMS" value="0">
  <input type="hidden" name="empleados-MAX_NUM_FORMS" value="100">

  <h3>Actividades asignadas</h3>
  
  {% if actividades_completadas %}
    <div class="actividades-completadas" style="background-color: #e8f5e8; padding: 10px; margin-bottom: 15px; border-radius: 5px;">
      <h4 style="color: #28a745; margin: 0 0 10px 0;">✅ Actividades completadas (no editables)</h4>
      {% for actividad in actividades_completadas %}
        <div style="padding: 5px 0; border-bottom: 1px solid #c3e6cb;">
          <strong>{{ actividad.nombre }}</strong> - {{ actividad.porcentaje }}% - ⏱️ {{ actividad.tiempo_estimado_dias }} día{{ actividad.tiempo_estimado_dias|pluralize }}
          {% if actividad.completada_por %}
            <span style="color: #6c757d; font-size: 0.9em;">
              (Completada por: {{ actividad.completada_por.nombre_completo }}
              {% if actividad.fecha_completada %} el {{ actividad.fecha_completada|date:"d/m/Y H:i" }}{% endif %})
            </span>
          {% endif %}
        </div>
      {% endfor %}
    </div>
  {% endif %}
  
  <h4>⏳ Actividades pendientes (editables)</h4>
  
  <!-- Controles rápidos de tiempo -->
  <div style="background-color: #f8f9fa; padding: 10px; margin-bottom: 15px; border-radius: 5px; border-left: 4px solid #007bff;">
    <strong>⏱️ Asignación rápida de tiempo:</strong>
    <div style="margin-top: 8px;">
      <button type="button" class="btn btn-sm btn-outline-primary" data-dias="1">Todas en 1 día</button>
      <button type="button" class="btn btn-sm btn-outline-primary" data-dias="2">Todas en 2 días</button>
      <button type="button" class="btn btn-sm btn-outline-primary" data-dias="3">Todas en 3 días</button>
      <button type="button" class="btn btn-sm btn-outline-primary" data-dias="7">Todas en 1 semana</button>
      <button type="button" class="btn btn-sm btn-outline-secondary" id="limpiar-tiempos">Limpiar tiempos</button>
    </div>
  </div>
  
  <div id="actividades-formset">
    {% for form in actividades_formset.forms %}
      <div class="actividad-form-row" style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
        {{ form.nombre }}
        {{ form.porcentaje }}<span>%</span>
        {{ form.tiempo_estimado_dias }}<span>días</span>
        <button type="button" class="remove-actividad btn btn-danger btn-sm">Eliminar</button>
      </div>
    {% endfor %}
    {% if actividades_formset.non_form_errors %}
      <div id="actividad-error-flash" class="alert alert-danger mt-2" role="alert">
        {% for error in actividades_formset.non_form_errors %}
          {{ error }}<br>
        {% endfor %}
      </div>
      <script>
        window.addEventListener('DOMContentLoaded', function() {
          var errorDiv = document.getElementById('actividad-error-flash');
          if (errorDiv) {
            errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        });
      </script>
    {% endif %}
  </div>
  <div id="actividad-empty-form" style="display:none;">
    <div class="actividad-form-row" style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
      <input type="text" name="actividades-__prefix__-nombre" placeholder="Actividad" />
      <input type="number" name="actividades-__prefix__-porcentaje" min="1" max="100" placeholder="%" />
      <span>%</span>
  <input type="number" name="actividades-__prefix__-tiempo_estimado_dias" min="1" max="365" placeholder="Días" />
      <span>días</span>
      <button type="button" class="remove-actividad btn btn-danger btn-sm">Eliminar</button>
    </div>
  </div>
  <button type="button" id="add-actividad" class="btn btn-success btn-sm">Agregar actividad</button>
  <input type="hidden" name="actividades-TOTAL_FORMS" id="id_actividades-TOTAL_FORMS" value="{{ actividades_formset.total_form_count }}">
  <input type="hidden" name="actividades-INITIAL_FORMS" value="{{ actividades_formset.initial_form_count }}">
  <input type="hidden" name="actividades-MIN_NUM_FORMS" value="0">
  <input type="hidden" name="actividades-MAX_NUM_FORMS" value="100">
{% block footer %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  $(function() {
    // Filtrar empleados cuando cambia el supervisor
    function filterEmpleados() {
      var supervisorId = $('#id_supervisor').val();
      $('#empleados-formset select[name*="empleado"]').each(function() {
        var $select = $(this);
        var currentValue = $select.val();
        $select.find('option').show();
        if (supervisorId) {
          $select.find('option[value="' + supervisorId + '"]').hide();
          if (currentValue === supervisorId) {
            $select.val('');
          }
        }
      });
    }
    
    // Aplicar filtro cuando cambia el supervisor
    $('#id_supervisor').change(filterEmpleados);
    
    // Aplicar filtro al cargar la página
    filterEmpleados();

    // Empleados
    var formIdx = {{ empleados_formset.total_form_count }};
    $('#add-empleado').click(function() {
      var $template = $('#empleado-empty-form .empleado-form-row').clone();
      $template.find('[name], [id], label').each(function() {
        $.each(this.attributes, function(i, attr) {
          if (attr.value && attr.value.indexOf('__prefix__') !== -1) {
            var nuevo = attr.value.replace(/__prefix__/g, formIdx);
            $(attr.ownerElement).attr(attr.name, nuevo);
          }
        });
      });
      $template.find('button.remove-empleado').show();
      $('#empleados-formset').append($template);
      formIdx++;
      $('#id_empleados-TOTAL_FORMS').val(formIdx);
      // Aplicar filtro al nuevo formulario
      filterEmpleados();
    });
    $(document).on('click', '.remove-empleado', function() {
      if ($('#empleados-formset .empleado-form-row').length > 1) {
        $(this).parent().remove();
        formIdx--;
        $('#id_empleados-TOTAL_FORMS').val(formIdx);
      }
    });
    $('.remove-empleado').first().hide();

    // Actividades
    var actIdx = {{ actividades_formset.total_form_count }};
    
    // Asignación rápida de tiempo
    $('[data-dias]').click(function() {
      var dias = $(this).data('dias');
      $('#actividades-formset input[name*="tiempo_estimado_dias"]').val(dias);
      
      // Mostrar feedback visual
      $(this).removeClass('btn-outline-primary').addClass('btn-primary');
      setTimeout(() => {
        $(this).removeClass('btn-primary').addClass('btn-outline-primary');
      }, 200);
    });
    
    $('#limpiar-tiempos').click(function() {
      $('#actividades-formset input[name*="tiempo_estimado_dias"]').val(1);
    });
    
    $('#add-actividad').click(function() {
      var $template = $('#actividad-empty-form .actividad-form-row').clone();
      $template.find('[name]').each(function() {
        var name = $(this).attr('name');
        if (name && name.indexOf('__prefix__') !== -1) {
          var nuevo = name.replace(/__prefix__/g, actIdx);
          $(this).attr('name', nuevo);
        }
      });
      $template.find('button.remove-actividad').show();
      $('#actividades-formset').append($template);
      actIdx++;
      $('#id_actividades-TOTAL_FORMS').val(actIdx);
    });
    $(document).on('click', '.remove-actividad', function() {
      if ($('#actividades-formset .actividad-form-row').length > 1) {
        $(this).parent().remove();
        actIdx--;
        $('#id_actividades-TOTAL_FORMS').val(actIdx);
      }
    });
    $('.remove-actividad').first().hide();
  });
</script>
{% endblock %}
{% endblock %}
