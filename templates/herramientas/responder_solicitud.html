{% extends 'base.html' %}
{% block title %}Responder Transferencia Herramienta{% endblock %}
{% block page_title %}Responder Transferencia de Herramienta{% endblock %}
{% block content %}
<div class="row">
  <div class="col-md-8">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-reply me-2"></i>Responder Solicitud de Transferencia</h5>
      </div>
      <div class="card-body">
        <div class="alert alert-info">
          <h6 class="mb-1"><i class="fas fa-tools me-2"></i>Herramienta Solicitada:</h6>
          <strong>{{ transferencia.herramienta.nombre }}</strong> ({{ transferencia.herramienta.codigo }})<br>
          <small class="text-muted">Categoría: {{ transferencia.herramienta.get_categoria_display }}{% if transferencia.herramienta.marca %} | Marca: {{ transferencia.herramienta.marca }}{% endif %}</small>
        </div>
        {% if transferencia.estado == 'inspeccion_enviada' %}
        <div class="alert alert-warning mb-3">
          <i class="fas fa-clipboard-check me-2"></i>
          El destino ya realizó una inspección. Revisa las observaciones y decide si apruebas (transferir) o cancelas.
        </div>
        {% elif transferencia.estado == 'inspeccion' %}
        <div class="alert alert-info mb-3">
          <i class="fas fa-search me-2"></i> La herramienta está en proceso de inspección.
        </div>
        {% endif %}
        <div class="mb-4">
          <h6><i class="fas fa-user me-2"></i>Solicitante:</h6>
          <p class="mb-1"><strong>{{ transferencia.empleado_origen.usuario.get_full_name }}</strong></p>
          <small class="text-muted">ID: {{ transferencia.empleado_origen.numero_empleado|default:'-' }}</small>
        </div>
        {% if transferencia.observaciones_solicitud %}
        <div class="mb-4">
          <h6><i class="fas fa-comment me-2"></i>Mensaje del solicitante:</h6>
          <div class="alert alert-light mb-0">{{ transferencia.observaciones_solicitud|linebreaks }}</div>
        </div>
        {% endif %}
        {% if transferencia.estado == 'inspeccion_enviada' and es_origen %}
        <div class="mb-4">
          <h6><i class="fas fa-search me-2"></i>Informe de Inspección:</h6>
          {% if transferencia.observaciones_inspeccion %}
          <div class="alert alert-secondary mb-2" style="white-space:pre-line;">{{ transferencia.observaciones_inspeccion }}</div>
          {% else %}
          <div class="alert alert-warning mb-2">El destino no agregó observaciones detalladas.</div>
          {% endif %}
          <small class="text-muted">Decide si apruebas (se transfiere la herramienta) o cancelas la transferencia.</small>
        </div>
        {% endif %}
        <div class="mb-4">
          <h6><i class="fas fa-calendar me-2"></i>Fecha de Solicitud:</h6>
          <p class="mb-0">{{ transferencia.fecha_solicitud|date:'d/m/Y H:i' }}</p>
        </div>
        <form method="post" class="mt-4">
          {% csrf_token %}
          <div class="mb-3">
            <label for="observaciones" class="form-label"><i class="fas fa-comment me-2"></i>Observaciones (Opcional)</label>
            <textarea class="form-control" name="observaciones" id="observaciones" rows="4" placeholder="Agrega comentarios sobre tu decisión..."></textarea>
            <small class="form-text text-muted">Se compartirán con el solicitante.</small>
          </div>
          {% if transferencia.estado in 'solicitada,inspeccion' %}
          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Importante:</strong> Si apruebas la transferencia ahora, la herramienta se reasignará inmediatamente. Si necesitas revisarla físicamente primero, usa la opción de inspeccionar.
          </div>
          {% elif transferencia.estado == 'inspeccion_enviada' %}
          <div class="alert alert-primary">
            <i class="fas fa-info-circle me-2"></i>
            La inspección fue enviada. Al aprobar se realizará la transferencia automática; al cancelar se cerrará la solicitud.
          </div>
          {% endif %}
          <div class="d-flex flex-wrap gap-2 justify-content-end">
            {% if transferencia.estado == 'solicitada' and es_destino %}
              <a href="{% url 'herramientas:inspeccionar_transferencia' transferencia.pk %}" class="btn btn-info"><i class="fas fa-search me-2"></i>Inspeccionar Primero</a>
              <button type="submit" name="respuesta" value="rechazar" class="btn btn-outline-danger"><i class="fas fa-times me-2"></i>Rechazar</button>
              <button type="submit" name="respuesta" value="aprobar" class="btn btn-success"><i class="fas fa-check me-2"></i>Aprobar</button>
            {% elif transferencia.estado == 'inspeccion' and es_destino %}
              <div class="alert alert-info flex-grow-1 mb-0"><i class="fas fa-info-circle me-1"></i> La inspección está en curso. Entra a la inspección para enviarla.</div>
              <a href="{% url 'herramientas:inspeccionar_transferencia' transferencia.pk %}" class="btn btn-info"><i class="fas fa-search me-2"></i>Continuar Inspección</a>
            {% elif transferencia.estado == 'inspeccion_enviada' and es_origen %}
              <button type="submit" name="respuesta" value="rechazar" class="btn btn-outline-danger"><i class="fas fa-times me-2"></i>Cancelar</button>
              <button type="submit" name="respuesta" value="aprobar" class="btn btn-success"><i class="fas fa-check me-2"></i>Transferir</button>
            {% elif transferencia.estado in 'aprobada,cancelada,rechazada' %}
              <div class="alert alert-secondary mb-0 flex-grow-1"><i class="fas fa-info-circle me-1"></i> Esta transferencia está cerrada.</div>
            {% endif %}
          </div>
        </form>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card mb-3">
      <div class="card-header"><h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Detalle Rápido</h6></div>
      <div class="card-body small">
        <p class="mb-1"><strong>Código:</strong> {{ transferencia.herramienta.codigo }}</p>
        <p class="mb-1"><strong>Estado:</strong> {{ transferencia.herramienta.get_estado_display }}</p>
        <p class="mb-1"><strong>Categoría:</strong> {{ transferencia.herramienta.get_categoria_display }}</p>
      </div>
    </div>
    <div class="card">
      <div class="card-header"><h6 class="mb-0"><i class="fas fa-cogs me-2"></i>Acciones</h6></div>
      <div class="card-body d-grid gap-2">
        <a href="{% url 'herramientas:transferencia_detalle' transferencia.pk %}" class="btn btn-outline-secondary w-100"><i class="fas fa-arrow-left me-2"></i>Volver al Detalle</a>
        <a href="{% url 'herramientas:mis_transferencias' %}" class="btn btn-outline-primary w-100"><i class="fas fa-list me-2"></i>Mis Transferencias</a>
      </div>
    </div>
  </div>
</div>
{% endblock %}
