{% extends "base.html" %}
{% load static %}

{% block title %}Registro de Ubicaci√≥n{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<style>
    .location-card {
        border-left: 4px solid #007bff;
        background: #f8f9fa;
    }
    .btn-location {
        min-height: 70px;
        font-size: 1.2rem;
        font-weight: 600;
        border: 2px solid;
        transition: all 0.3s ease;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .btn-location:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0,0,0,0.2);
    }
    .btn-success-custom {
        background: linear-gradient(135deg, #28a745, #20c997);
        border-color: #28a745;
        color: white;
    }
    .btn-success-custom:hover:not(.disabled) {
        background: linear-gradient(135deg, #218838, #1e7e34);
        border-color: #1e7e34;
        color: white;
    }
    .btn-warning-custom {
        background: linear-gradient(135deg, #fd7e14, #ffc107);
        border-color: #fd7e14;
        color: white;
    }
    .btn-warning-custom:hover:not(.disabled) {
        background: linear-gradient(135deg, #e8690b, #e0a800);
        border-color: #dc6002;
        color: white;
    }
    .btn-location.disabled {
        opacity: 0.6;
        transform: none !important;
        box-shadow: none !important;
    }
    .location-status {
        font-size: 0.9rem;
        padding: 0.5rem;
        border-radius: 0.375rem;
        margin-bottom: 1rem;
    }
    .status-success {
        background-color: #d1e7dd;
        border: 1px solid #badbcc;
        color: #0f5132;
    }
    .status-warning {
        background-color: #fff3cd;
        border: 1px solid #ffecb5;
        color: #664d03;
    }

    .registro-item {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 1rem;
        margin-bottom: 0.5rem;
    }
    .registro-entrada {
        border-left: 4px solid #28a745;
    }
    .registro-salida {
        border-left: 4px solid #dc3545;
    }
    .loading-spinner {
        display: none;
    }
    .loading .loading-spinner {
        display: inline-block;
    }
    .loading .btn-text {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card location-card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-map-marker-alt me-2"></i>
                        Control de Asistencia por Ubicaci√≥n
                    </h4>
                </div>
                <div class="card-body">
                    <!-- Informaci√≥n del empleado -->
                    <div class="mb-4">
                        <h5>Empleado: {{ empleado.nombre_completo }}</h5>
                        <p class="text-muted mb-0">N√∫mero: {{ empleado.numero_empleado }}</p>
                        <p class="text-muted">Puesto: {{ empleado.puesto.nombre }}</p>
                    </div>

                    <!-- Estado actual -->
                    <div class="location-status {% if ya_registro_entrada and ya_registro_salida %}status-success{% elif ya_registro_entrada %}status-warning{% else %}status-info{% endif %}">
                        {% if ya_registro_entrada and ya_registro_salida %}
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>Registros completos:</strong> Ya registraste entrada y salida para hoy.
                        {% elif ya_registro_entrada %}
                            <i class="fas fa-clock me-2"></i>
                            <strong>Entrada registrada:</strong> Recuerda registrar tu salida al terminar la jornada.
                        {% else %}
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Sin registros hoy:</strong> Registra tu entrada al llegar al trabajo.
                        {% endif %}
                    </div>

                    <!-- Botones de acci√≥n -->
                    <div class="row mb-4">
                        <div class="col-md-6 mb-3">
                            <button 
                                type="button" 
                                class="btn btn-success-custom btn-location w-100 {% if ya_registro_entrada %}disabled{% endif %}" 
                                onclick="confirmarYRegistrar('entrada')"
                                {% if ya_registro_entrada %}disabled{% endif %}>
                                <span class="btn-text">
                                    <i class="fas fa-sign-in-alt me-2"></i>
                                    {% if ya_registro_entrada %}
                                        ‚úÖ Entrada Registrada
                                    {% else %}
                                        üìç Registrar Entrada
                                    {% endif %}
                                </span>
                                <span class="loading-spinner">
                                    <i class="fas fa-spinner fa-spin me-2"></i>
                                    Obteniendo ubicaci√≥n...
                                </span>
                            </button>
                        </div>
                        <div class="col-md-6 mb-3">
                            <button 
                                type="button" 
                                class="btn btn-warning-custom btn-location w-100 {% if ya_registro_salida or not ya_registro_entrada %}disabled{% endif %}" 
                                onclick="confirmarYRegistrar('salida')"
                                {% if ya_registro_salida or not ya_registro_entrada %}disabled{% endif %}>
                                <span class="btn-text">
                                    <i class="fas fa-sign-out-alt me-2"></i>
                                    {% if ya_registro_salida %}
                                        ‚úÖ Salida Registrada
                                    {% elif not ya_registro_entrada %}
                                        ‚è≥ Registra Entrada Primero
                                    {% else %}
                                        üìç Registrar Salida
                                    {% endif %}
                                </span>
                                <span class="loading-spinner">
                                    <i class="fas fa-spinner fa-spin me-2"></i>
                                    Obteniendo ubicaci√≥n...
                                </span>
                            </button>
                        </div>
                    </div>

                    <!-- Informaci√≥n de ubicaci√≥n -->
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle me-2"></i>¬øC√≥mo funciona el registro de ubicaci√≥n?</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <p class="mb-2"><strong>üìç Proceso:</strong></p>
                                <p class="mb-0 small">
                                    1. Haz clic en "Registrar Entrada/Salida"<br>
                                    2. <strong>El navegador pedir√° permiso de ubicaci√≥n</strong><br>
                                    3. <strong>Selecciona "Permitir" cuando aparezca</strong><br>
                                    4. Tu posici√≥n GPS se registrar√° autom√°ticamente
                                </p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-2"><strong>‚ö†Ô∏è Importante:</strong></p>
                                <p class="mb-0 small">
                                    ‚Ä¢ Solo una entrada y una salida por d√≠a<br>
                                    ‚Ä¢ Activa el GPS para mayor precisi√≥n<br>
                                    ‚Ä¢ Permite el acceso cuando lo solicite<br>
                                    ‚Ä¢ Recarga la p√°gina si hay problemas
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Alerta de permisos -->
                    <div class="alert alert-warning" id="alertaPermisos" style="display: none;">
                        <h6><i class="fas fa-exclamation-triangle me-2"></i>¬øNo aparece la solicitud de ubicaci√≥n?</h6>
                        <p class="mb-2">Si no ves la ventana pidiendo permisos de ubicaci√≥n:</p>
                        <ol class="mb-0 small">
                            <li>Busca el √≠cono de ubicaci√≥n üìç en la barra de direcciones del navegador</li>
                            <li>Haz clic en √©l y selecciona "Permitir ubicaci√≥n para este sitio"</li>
                            <li>Recarga la p√°gina (F5) e intenta de nuevo</li>
                        </ol>
                    </div>

                    <!-- Registros de hoy -->
                    {% if registros_hoy %}
                    <div class="mt-4">
                        <h6>Registros de hoy:</h6>
                        {% for registro in registros_hoy %}
                        <div class="registro-item registro-{{ registro.tipo }}">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>{{ registro.get_tipo_display }}</strong>
                                    <small class="text-muted d-block">{{ registro.fecha_local|date:"H:i:s" }}</small>
                                </div>
                                <div class="text-end">
                                    <small class="text-muted">{{ registro.coordenadas_str }}</small>
                                    {% if registro.precision %}
                                    <small class="text-muted d-block">Precisi√≥n: {{ registro.precision|floatformat:0 }}m</small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
// Variables globales
let currentPosition = null;
let currentType = null;

function confirmarYRegistrar(tipo) {
    console.log('üîò Usuario hizo clic en registrar', tipo);
    
    // Confirmaci√≥n previa clara
    const tipoTexto = tipo === 'entrada' ? 'ENTRADA' : 'SALIDA';
    const confirmacion = confirm(
        `üéØ ¬øREGISTRAR ${tipoTexto}?\n\n` +
        `‚úì Se solicitar√° acceso a tu ubicaci√≥n GPS\n` +
        `‚úì Debes PERMITIR el acceso cuando aparezca la ventana\n` +
        `‚úì Solo puedes registrar una ${tipo} por d√≠a\n\n` +
        `¬øContinuar con el registro?`
    );
    
    if (!confirmacion) {
        console.log('‚ùå Usuario cancel√≥ el registro');
        return;
    }
    
    // Verificar soporte de geolocalizaci√≥n
    if (!("geolocation" in navigator)) {
        alert("‚ùå Tu navegador no soporta geolocalizaci√≥n.\n\nPor favor, usa un navegador moderno como Chrome, Firefox o Safari.");
        return;
    }
    
    console.log('‚úÖ Procediendo con el registro de', tipo);
    
    // Proceder con el registro
    registrarUbicacion(tipo);
}

function registrarUbicacion(tipo) {
    currentType = tipo;
    const button = event.target ? event.target.closest('button') : 
                  document.querySelector(`button[onclick="confirmarYRegistrar('${tipo}')"]`);
    
    console.log(`Iniciando registro de ${tipo}`);
    
    if (button) {
        button.classList.add('loading');
    }

    // Verificar soporte de geolocalizaci√≥n
    if (!("geolocation" in navigator)) {
        if (button) {
            button.classList.remove('loading');
        }
        alert("‚ùå Tu navegador no soporta geolocalizaci√≥n.\n\nPor favor, usa un navegador moderno como Chrome, Firefox o Safari.");
        return;
    }

    // Proceder directamente con la solicitud de ubicaci√≥n
    // El navegador manejar√° autom√°ticamente la solicitud de permisos
    solicitarUbicacion(tipo, button);
}

function solicitarUbicacion(tipo, button) {
    const tipoTexto = tipo === 'entrada' ? 'entrada' : 'salida';
    console.log(`Solicitando ubicaci√≥n GPS para registro de ${tipoTexto}`);
    
    // AQU√ç es donde el navegador solicitar√° permisos si no los tiene
    navigator.geolocation.getCurrentPosition(
        // Funci√≥n de √©xito
        function(position) {
            console.log('‚úÖ Ubicaci√≥n obtenida exitosamente:', position.coords);
            currentPosition = position;
            
            if (button) {
                button.classList.remove('loading');
            }
            
            // Registrar la ubicaci√≥n inmediatamente
            enviarRegistro(position, tipo);
        },
        // Funci√≥n de error
        function(error) {
            console.error('‚ùå Error al obtener ubicaci√≥n. C√≥digo:', error.code, 'Mensaje:', error.message);
            
            if (button) {
                button.classList.remove('loading');
            }
            
            let errorMessage = "";
            
            switch(error.code) {
                case 1: // PERMISSION_DENIED
                    errorMessage = "üö´ PERMISOS DE UBICACI√ìN DENEGADOS\n\n" +
                                  "Para registrar tu asistencia necesitas permitir el acceso a la ubicaci√≥n:\n\n" +
                                  "1Ô∏è‚É£ Busca el √≠cono üìç en la barra de direcciones del navegador\n" +
                                  "2Ô∏è‚É£ Haz clic en √©l y selecciona 'Permitir'\n" +
                                  "3Ô∏è‚É£ Recarga la p√°gina (F5) e intenta de nuevo\n\n" +
                                  "Si no aparece el √≠cono, revisa la configuraci√≥n de privacidad de tu navegador.";
                    break;
                    
                case 2: // POSITION_UNAVAILABLE
                    errorMessage = "üì° SE√ëAL GPS NO DISPONIBLE\n\n" +
                                  "No se pudo determinar tu ubicaci√≥n:\n\n" +
                                  "‚Ä¢ Aseg√∫rate de tener conexi√≥n a internet\n" +
                                  "‚Ä¢ Si est√°s en interiores, ac√©rcate a una ventana\n" +
                                  "‚Ä¢ Verifica que el GPS est√© activado en tu dispositivo\n" +
                                  "‚Ä¢ Intenta de nuevo en unos segundos";
                    break;
                    
                case 3: // TIMEOUT
                    errorMessage = "‚è±Ô∏è TIEMPO DE ESPERA AGOTADO\n\n" +
                                  "La ubicaci√≥n tard√≥ demasiado en obtenerse:\n\n" +
                                  "‚Ä¢ Verifica tu conexi√≥n a internet\n" +
                                  "‚Ä¢ Aseg√∫rate de que el GPS est√© activado\n" +
                                  "‚Ä¢ Intenta de nuevo";
                    break;
                    
                default:
                    errorMessage = `‚ùì ERROR DESCONOCIDO (${error.code})\n\n` +
                                  "Ocurri√≥ un problema inesperado.\n" +
                                  "Intenta de nuevo o contacta al administrador.";
            }
            
            alert(errorMessage);
        },
        // Opciones de geolocalizaci√≥n
        {
            enableHighAccuracy: true,  // Usar GPS de alta precisi√≥n
            timeout: 15000,           // 15 segundos de timeout
            maximumAge: 60000         // Usar ubicaci√≥n cacheada si es menor a 1 minuto
        }
    );
}

function enviarRegistro(position, tipo) {
    const data = {
        latitud: position.coords.latitude,
        longitud: position.coords.longitude,
        precision: position.coords.accuracy,
        tipo: tipo
    };
    
    const tipoTexto = tipo === 'entrada' ? 'ENTRADA' : 'SALIDA';
    console.log(`Enviando registro de ${tipoTexto}:`, data);
    
    fetch('{% url "ubicaciones:api_registrar" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Mostrar mensaje de √©xito m√°s detallado
            const precisionTexto = position.coords.accuracy < 20 ? "Excelente" : 
                                 position.coords.accuracy < 50 ? "Buena" : "Aceptable";
            
            alert(`‚úÖ ¬°${tipoTexto} REGISTRADA EXITOSAMENTE!\n\n` +
                  `üïí Hora: ${data.timestamp}\n` +
                  `üìç Coordenadas: ${position.coords.latitude.toFixed(6)}, ${position.coords.longitude.toFixed(6)}\n` +
                  `üéØ Precisi√≥n: ${position.coords.accuracy.toFixed(0)} metros (${precisionTexto})\n\n` +
                  `Tu asistencia ha sido registrada correctamente.`);
            
            // Recargar para actualizar el estado
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            alert(`‚ùå Error al registrar ${tipo.toUpperCase()}:\n\n${data.error}\n\nSi el problema persiste, contacta al administrador.`);
        }
    })
    .catch(error => {
        console.error('Error de conexi√≥n:', error);
        alert(`‚ùå Error de conexi√≥n al registrar ${tipo.toUpperCase()}.\n\n` +
              `Posibles causas:\n` +
              `‚Ä¢ Sin conexi√≥n a internet\n` +
              `‚Ä¢ Problema del servidor\n\n` +
              `Verifica tu conexi√≥n e int√©ntalo de nuevo.`);
    });
}

// Funciones de limpieza al salir de la p√°gina
function limpiarRecursos() {
    currentPosition = null;
    currentType = null;
    if (map) {
        map.remove();
        map = null;
    }
}

// Verificar estado de permisos al cargar la p√°gina (SIN solicitar ubicaci√≥n)
document.addEventListener('DOMContentLoaded', function() {
    verificarEstadoPermisosSinSolicitar();
});

function verificarEstadoPermisosSinSolicitar() {
    if ('permissions' in navigator) {
        navigator.permissions.query({name: 'geolocation'}).then(function(permissionStatus) {
            const alertaPermisos = document.getElementById('alertaPermisos');
            
            console.log('Estado actual de permisos:', permissionStatus.state);
            
            switch(permissionStatus.state) {
                case 'denied':
                    if (alertaPermisos) {
                        alertaPermisos.style.display = 'block';
                        alertaPermisos.className = 'alert alert-danger';
                        alertaPermisos.innerHTML = `
                            <h6><i class="fas fa-ban me-2"></i>Permisos de ubicaci√≥n bloqueados</h6>
                            <p class="mb-2">Para usar el registro de asistencia necesitas habilitar la ubicaci√≥n:</p>
                            <ol class="mb-0 small">
                                <li>Haz clic en el √≠cono de ubicaci√≥n üìç en la barra de direcciones</li>
                                <li>Selecciona "Permitir ubicaci√≥n para este sitio"</li>
                                <li>Recarga la p√°gina (F5)</li>
                            </ol>
                        `;
                    }
                    break;
                case 'granted':
                    console.log('Permisos de ubicaci√≥n ya otorgados - listos para usar');
                    // Los permisos est√°n otorgados, pero NO solicitamos ubicaci√≥n aqu√≠
                    break;
                case 'prompt':
                    console.log('Se solicitar√°n permisos cuando el usuario haga clic');
                    // Se solicitar√°n permisos cuando se use la funci√≥n
                    break;
            }
            
            // Escuchar cambios en los permisos (pero sin solicitar ubicaci√≥n)
            permissionStatus.onchange = function() {
                console.log('Estado de permisos cambi√≥ a:', this.state);
                // NO recargar autom√°ticamente, solo informar
            };
        }).catch(function(error) {
            console.log('API de permisos no disponible (normal en algunos navegadores):', error);
        });
    } else {
        console.log('API de permisos no disponible - se solicitar√°n cuando sea necesario');
    }
}

// Limpiar al salir de la p√°gina  
window.addEventListener('beforeunload', limpiarRecursos);
</script>
{% endblock %}