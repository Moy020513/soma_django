{% extends "base.html" %}
{% load static %}

{% block title %}Registro de Ubicaci√≥n{% endblock %}

{% block extra_css %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<!-- Leaflet JavaScript -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
    .location-card {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        border: 1px solid #e3e6f0;
        margin-bottom: 20px;
    }
    
    .info-grid {
        display: grid;
        gap: 12px;
    }
    
    .info-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #f1f3f4;
    }
    
    .info-item:last-child {
        border-bottom: none;
    }
    
    .map-placeholder {
        background: #f8f9fc;
        border-radius: 8px;
        padding: 20px;
        border: 2px dashed #d1d3e2;
    }
    
    #mapContainer {
        opacity: 0;
        transition: opacity 0.3s ease;
        margin-top: 20px;
    }
    
    #mapContainer.show {
        opacity: 1;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">üìç Control de Asistencia</h1>
    </div>

    <div class="row">
        <div class="col-xl-8 col-lg-7">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-clock"></i> Registro de Asistencia
                    </h6>
                    <div class="badge badge-success">{{ empleado.nombre_completo }}</div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <button id="btnRegistrarEntrada" 
                                    class="btn btn-success btn-lg btn-block mb-3"
                                    onclick="confirmarRegistro('entrada')">
                                <i class="fas fa-sign-in-alt"></i>
                                <strong>ENTRADA</strong>
                                <small class="d-block">Registrar llegada</small>
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button id="btnRegistrarSalida" 
                                    class="btn btn-danger btn-lg btn-block mb-3"
                                    onclick="confirmarRegistro('salida')">
                                <i class="fas fa-sign-out-alt"></i>
                                <strong>SALIDA</strong>
                                <small class="d-block">Registrar salida</small>
                            </button>
                        </div>
                    </div>
                    
                    <div id="ubicacionInfo" class="alert alert-info" style="display: none;">
                        <i class="fas fa-spinner fa-spin"></i> Obteniendo ubicaci√≥n...
                    </div>
                    
                    <div id="statusMessage" class="mt-3"></div>
                </div>
            </div>
        </div>

        <div class="col-xl-4 col-lg-5">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-history"></i> Registros Recientes
                    </h6>
                </div>
                <div class="card-body">
                    {% if registros_recientes %}
                        {% for registro in registros_recientes %}
                        <div class="border-left-{{ registro.tipo|yesno:'success,danger' }} p-3 mb-3 bg-light">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong class="text-{{ registro.tipo|yesno:'success,danger' }}">
                                        <i class="fas fa-{{ registro.tipo|yesno:'sign-in-alt,sign-out-alt' }}"></i>
                                        {{ registro.get_tipo_display|upper }}
                                    </strong>
                                    <br>
                                    <small class="text-muted">
                                        {{ registro.fecha_local|date:"j M Y" }} - {{ registro.fecha_local|date:"H:i:s" }}
                                    </small>
                                </div>
                                <button class="btn btn-outline-primary btn-sm" 
                                        data-lat="{{ registro.latitud }}" 
                                        data-lng="{{ registro.longitud }}" 
                                        data-accuracy="{{ registro.precision|default:50 }}" 
                                        data-timestamp="{{ registro.fecha_local|date:'H:i:s' }}" 
                                        data-tipo="{{ registro.get_tipo_display|lower }}"
                                        onclick="mostrarMapaRegistroFromData(this)">
                                    <i class="fas fa-map-marker-alt"></i>
                                    Ver
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center text-muted">
                            <i class="fas fa-clock fa-2x mb-2"></i>
                            <p>No hay registros recientes</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Contenedor para mostrar informaci√≥n del mapa -->
    <div id="mapContainer" style="display: block;"></div>
</div>

<script>
console.log('üöÄ Control de Asistencia SOMA - Listo');

// Verificaci√≥n de carga de Leaflet
console.log('üçÉ Verificando carga de Leaflet...');

// Funci√≥n para mostrar informaci√≥n de registros anteriores (definir primero)
window.mostrarMapaRegistro = function(lat, lng, accuracy, timestamp, tipo) {
    console.log('üó∫Ô∏è Mostrando ubicaci√≥n de registro:', tipo);
    console.log('üîç DEBUG PAR√ÅMETROS:');
    console.log('  lat:', lat, typeof lat);
    console.log('  lng:', lng, typeof lng);
    console.log('  accuracy:', accuracy, typeof accuracy);
    console.log('  timestamp:', timestamp, typeof timestamp);
    console.log('  tipo:', tipo, typeof tipo);
    
    // Convertir par√°metros a n√∫meros
    const latNum = parseFloat(lat);
    const lngNum = parseFloat(lng);
    
    console.log('üîç DESPU√âS DE CONVERSI√ìN:');
    console.log('  latNum:', latNum);
    console.log('  lngNum:', lngNum);
    
    // Validar que los par√°metros sean correctos
    if (isNaN(latNum) || isNaN(lngNum)) {
        console.error('‚ùå Coordenadas inv√°lidas:', lat, lng);
        return;
    }
    
    // Mostrar informaci√≥n inmediatamente
    initMap(latNum, lngNum, accuracy, timestamp, tipo);
    
    // Scroll hacia la informaci√≥n
    setTimeout(() => {
        const mapContainer = document.getElementById('mapContainer');
        if (mapContainer) {
            mapContainer.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center' 
            });
        }
    }, 100);
};

// Nueva funci√≥n que lee datos desde atributos del bot√≥n (evita problemas de localizaci√≥n)
window.mostrarMapaRegistroFromData = function(button) {
    // Leer datos desde los atributos data-* del bot√≥n
    const lat = button.getAttribute('data-lat');
    const lng = button.getAttribute('data-lng');
    const accuracy = button.getAttribute('data-accuracy');
    const timestamp = button.getAttribute('data-timestamp');
    const tipo = button.getAttribute('data-tipo');
    
    console.log('üó∫Ô∏è Mostrando ubicaci√≥n de registro:', tipo);
    console.log('üîç DEBUG PAR√ÅMETROS DESDE DATA:');
    console.log('  lat:', lat, typeof lat);
    console.log('  lng:', lng, typeof lng);
    console.log('  accuracy:', accuracy, typeof accuracy);
    console.log('  timestamp:', timestamp, typeof timestamp);
    console.log('  tipo:', tipo, typeof tipo);
    
    // Convertir a n√∫meros (reemplazar comas por puntos si es necesario)
    const latNum = parseFloat(lat.replace(',', '.'));
    const lngNum = parseFloat(lng.replace(',', '.'));
    const accuracyNum = parseFloat(accuracy.replace(',', '.'));
    
    console.log('üîç DESPU√âS DE CONVERSI√ìN Y LIMPIEZA:');
    console.log('  latNum:', latNum);
    console.log('  lngNum:', lngNum);
    console.log('  accuracyNum:', accuracyNum);
    
    // Validar que los par√°metros sean correctos
    if (isNaN(latNum) || isNaN(lngNum)) {
        console.error('‚ùå Coordenadas inv√°lidas:', lat, lng);
        return;
    }
    
    // Mostrar informaci√≥n inmediatamente
    initMap(latNum, lngNum, accuracyNum, timestamp, tipo);
    
    // Scroll hacia la informaci√≥n
    setTimeout(() => {
        const mapContainer = document.getElementById('mapContainer');
        if (mapContainer) {
            mapContainer.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center' 
            });
        }
    }, 100);
};

// Funci√≥n para inicializar el mapa
function initMap(lat, lng, accuracy, timestamp, tipo) {
    // Convertir par√°metros a n√∫meros
    const latNum = parseFloat(lat);
    const lngNum = parseFloat(lng);
    
    console.log('üìç Mostrando ubicaci√≥n:', latNum.toFixed(6), lngNum.toFixed(6));
    
    // Verificaci√≥n r√°pida de Leaflet - sin esperas
    if (typeof L !== 'undefined' && window.leafletLoaded) {
        console.log('üó∫Ô∏è Creando mapa interactivo');
        createMap(latNum, lngNum, accuracy, timestamp, tipo);
    } else {
        console.log('üìã Usando vista de informaci√≥n');
        mostrarInfoSinMapa(latNum, lngNum, accuracy, timestamp, tipo);
    }
}

// Funci√≥n separada para crear el mapa
function createMap(lat, lng, accuracy, timestamp, tipo) {
    console.log('üó∫Ô∏è Creando mapa con Leaflet disponible');
    
    const mapContainer = document.getElementById('mapContainer');
    if (mapContainer) {
        mapContainer.innerHTML = '<div id="locationMap" style="height: 300px; border-radius: 8px;"></div>';
        mapContainer.classList.add('show');
    }
    
    setTimeout(() => {
        try {
            const map = L.map('locationMap').setView([lat, lng], 16);
            console.log('‚úÖ Mapa creado exitosamente');
            
            // Agregar tiles de OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
            
            // Obtener descripci√≥n de precisi√≥n
            let precisionText = 'Media';
            if (accuracy <= 10) precisionText = 'Excelente';
            else if (accuracy <= 50) precisionText = 'Buena';
            else if (accuracy <= 100) precisionText = 'Media';
            else precisionText = 'Baja';
            
            // Agregar marcador
            L.marker([lat, lng]).addTo(map)
                .bindPopup(`
                    <div class="text-center">
                        <strong>üìç ${tipo.charAt(0).toUpperCase() + tipo.slice(1)}</strong><br>
                        <small>
                            ${timestamp}<br>
                            Precisi√≥n: ${accuracy ? accuracy.toFixed(0) : '50'}m (${precisionText})
                        </small>
                    </div>
                `).openPopup();
                
        } catch (error) {
            console.error('‚ùå Error al crear mapa:', error);
            mostrarInfoSinMapa(lat, lng, accuracy, timestamp, tipo);
        }
    }, 100);
}

// Funci√≥n para mostrar informaci√≥n sin mapa cuando Leaflet falla
function mostrarInfoSinMapa(lat, lng, accuracy, timestamp, tipo) {
    console.log('üìã Mostrando informaci√≥n sin mapa interactivo');
    
    // Convertir par√°metros a n√∫meros si son strings
    const latNum = parseFloat(lat);
    const lngNum = parseFloat(lng);
    
    // Obtener descripci√≥n de precisi√≥n
    let precisionText = 'Media';
    if (accuracy <= 10) precisionText = 'Excelente';
    else if (accuracy <= 50) precisionText = 'Buena';
    else if (accuracy <= 100) precisionText = 'Media';
    else precisionText = 'Baja';
    
    const mapContainer = document.getElementById('mapContainer');
    if (mapContainer) {
        mapContainer.innerHTML = `
            <div class="location-card">
                <div class="row">
                    <div class="col-md-8">
                        <h5 class="mb-3">üìç Informaci√≥n de Ubicaci√≥n</h5>
                        
                        <div class="info-grid">
                            <div class="info-item">
                                <strong>üåê Latitud:</strong>
                                <span>${latNum.toFixed(6)}</span>
                            </div>
                            
                            <div class="info-item">
                                <strong>üåê Longitud:</strong>
                                <span>${lngNum.toFixed(6)}</span>
                            </div>
                            
                            <div class="info-item">
                                <strong>üéØ Precisi√≥n:</strong>
                                <span>${accuracy ? accuracy.toFixed(0) : '50'}m (${precisionText})</span>
                            </div>
                            
                            <div class="info-item">
                                <strong>‚è∞ Hora:</strong>
                                <span>${timestamp}</span>
                            </div>
                            
                            <div class="info-item">
                                <strong>üìã Tipo:</strong>
                                <span>${tipo.charAt(0).toUpperCase() + tipo.slice(1)}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4 text-center">
                        <div class="map-placeholder">
                            <i class="fas fa-map-marked-alt fa-3x text-primary mb-2"></i>
                            <p class="text-muted small">Mapa no disponible</p>
                            
                            <a href="https://www.google.com/maps?q=${latNum},${lngNum}" 
                               target="_blank" 
                               class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-external-link-alt"></i>
                                Ver en Google Maps
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        `;
        mapContainer.classList.add('show');
    }
}

// Funci√≥n para confirmar y realizar el registro
function confirmarRegistro(tipo) {
    console.log('üéØ Confirmando registro de', tipo);
    
    if (!navigator.geolocation) {
        alert('‚ùå Tu navegador no soporta geolocalizaci√≥n');
        return;
    }

    const btnEntrada = document.getElementById('btnRegistrarEntrada');
    const btnSalida = document.getElementById('btnRegistrarSalida');
    const ubicacionInfo = document.getElementById('ubicacionInfo');
    
    // Deshabilitar botones mientras se procesa
    btnEntrada.disabled = true;
    btnSalida.disabled = true;
    ubicacionInfo.style.display = 'block';
    ubicacionInfo.innerHTML = '<i class="fas fa-spinner fa-spin"></i> üìç Obteniendo tu ubicaci√≥n...';

    navigator.geolocation.getCurrentPosition(
        function(position) {
            const coords = {
                latitude: position.coords.latitude,
                longitude: position.coords.longitude,
                accuracy: position.coords.accuracy,
                altitude: position.coords.altitude,
                altitudeAccuracy: position.coords.altitudeAccuracy,
                heading: position.coords.heading,
                speed: position.coords.speed
            };
            
            console.log('üìç Ubicaci√≥n obtenida:', coords);
            console.log('üéØ Precisi√≥n GPS:', coords.accuracy, 'metros');
            console.log('üìç Coordenadas exactas:', coords.latitude.toFixed(8), coords.longitude.toFixed(8));
            
            // Mostrar informaci√≥n de precisi√≥n al usuario
            const precisionInfo = coords.accuracy <= 5 ? 'Excelente' : 
                                 coords.accuracy <= 15 ? 'Muy buena' :
                                 coords.accuracy <= 50 ? 'Buena' : 'Regular';
            
            ubicacionInfo.innerHTML = `
                <i class="fas fa-spinner fa-spin"></i> üìç Ubicaci√≥n obtenida con precisi√≥n ${precisionInfo}
                <br><small>Precisi√≥n: ${coords.accuracy.toFixed(1)}m - Guardando...</small>
            `;
            
            enviarRegistro(tipo, coords);
        },
        function(error) {
            console.error('‚ùå Error de geolocalizaci√≥n:', error);
            let mensaje = '‚ùå No se pudo obtener la ubicaci√≥n. ';
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    mensaje += 'Por favor, permite el acceso a tu ubicaci√≥n.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    mensaje += 'Tu ubicaci√≥n no est√° disponible.';
                    break;
                case error.TIMEOUT:
                    mensaje += 'Se agot√≥ el tiempo de espera.';
                    break;
            }
            
            ubicacionInfo.innerHTML = mensaje;
            ubicacionInfo.className = 'alert alert-danger';
            
            // Rehabilitar botones
            btnEntrada.disabled = false;
            btnSalida.disabled = false;
        },
        {
            enableHighAccuracy: true,  // Usar GPS en lugar de WiFi/celular
            timeout: 15000,             // 15 segundos para obtener ubicaci√≥n precisa
            maximumAge: 0              // No usar ubicaci√≥n en cach√©, siempre nueva
        }
    );
}

// Funci√≥n para enviar el registro al servidor
function enviarRegistro(tipo, coords) {
    const ubicacionInfo = document.getElementById('ubicacionInfo');
    
    ubicacionInfo.innerHTML = '<i class="fas fa-spinner fa-spin"></i> üíæ Guardando registro...';
    
    const formData = new FormData();
    formData.append('tipo', tipo);
    formData.append('latitud', coords.latitude);
    formData.append('longitud', coords.longitude);
    formData.append('precision', coords.accuracy);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

    fetch('{% url "ubicaciones:api_registrar" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => response.json())
    .then(data => {
        console.log('üì° Respuesta del servidor:', data);
        
        if (data.success) {
            ubicacionInfo.innerHTML = `
                <i class="fas fa-check-circle"></i> 
                <strong>‚úÖ ${data.message}</strong>
                <br><small>üìç Ubicaci√≥n: ${coords.latitude.toFixed(6)}, ${coords.longitude.toFixed(6)}</small>
                <br><small>üéØ Precisi√≥n: ${coords.accuracy.toFixed(0)}m</small>
            `;
            ubicacionInfo.className = 'alert alert-success';
            
            // Deshabilitar el bot√≥n del tipo registrado
            if (tipo === 'entrada') {
                const btnEntrada = document.getElementById('btnRegistrarEntrada');
                btnEntrada.disabled = true;
                btnEntrada.innerHTML = '<i class="fas fa-check"></i><strong>ENTRADA REGISTRADA</strong><small class="d-block">Ya registrado hoy</small>';
                btnEntrada.className = 'btn btn-success btn-lg btn-block mb-3 disabled';
            } else if (tipo === 'salida') {
                const btnSalida = document.getElementById('btnRegistrarSalida');
                btnSalida.disabled = true;
                btnSalida.innerHTML = '<i class="fas fa-check"></i><strong>SALIDA REGISTRADA</strong><small class="d-block">Ya registrado hoy</small>';
                btnSalida.className = 'btn btn-danger btn-lg btn-block mb-3 disabled';
            }
            
            // Habilitar el otro bot√≥n
            if (tipo === 'entrada') {
                document.getElementById('btnRegistrarSalida').disabled = false;
            } else {
                document.getElementById('btnRegistrarEntrada').disabled = false;
            }
            
            // Recargar la p√°gina despu√©s de 3 segundos para mostrar el nuevo registro
            setTimeout(() => {
                window.location.reload();
            }, 3000);
        } else {
            ubicacionInfo.innerHTML = '‚ùå ' + (data.message || 'Error al guardar el registro');
            ubicacionInfo.className = 'alert alert-danger';
            
            // En caso de error, rehabilitar botones
            document.getElementById('btnRegistrarEntrada').disabled = false;
            document.getElementById('btnRegistrarSalida').disabled = false;
        }
    })
    .catch(error => {
        console.error('‚ùå Error:', error);
        ubicacionInfo.innerHTML = '‚ùå Error de conexi√≥n. Por favor, intenta de nuevo.';
        ubicacionInfo.className = 'alert alert-danger';
        
        // En caso de error, rehabilitar botones
        document.getElementById('btnRegistrarEntrada').disabled = false;
        document.getElementById('btnRegistrarSalida').disabled = false;
    });
}

// Inicializaci√≥n cuando el DOM est√° listo
document.addEventListener('DOMContentLoaded', function() {
    console.log('‚úÖ Sistema operativo');
    
    // Configuraci√≥n de Leaflet
    setTimeout(function() {
        if (typeof L !== 'undefined') {
            console.log('‚úÖ Leaflet cargado exitosamente! Versi√≥n:', L.version);
            window.leafletLoaded = true;
        } else {
            console.warn('‚ö†Ô∏è Leaflet no se carg√≥, marcando como fallido');
            window.leafletLoadFailed = true;
        }
    }, 1000);
    
    console.log('üîß Configurando event listeners...');
    
    const btnEntrada = document.getElementById('btnRegistrarEntrada');
    const btnSalida = document.getElementById('btnRegistrarSalida');
    
    console.log('üîç Bot√≥n entrada encontrado:', btnEntrada ? 'S√ç' : 'NO');
    console.log('üîç Bot√≥n salida encontrado:', btnSalida ? 'S√ç' : 'NO');
    
    console.log('üéØ Todos los event listeners configurados');
    
    // Verificar estado inicial de los botones seg√∫n registros del d√≠a
    {% if ya_registro_entrada %}
    if (btnEntrada) {
        btnEntrada.disabled = true;
        btnEntrada.innerHTML = '<i class="fas fa-check"></i><strong>ENTRADA REGISTRADA</strong><small class="d-block">Ya registrado hoy</small>';
        btnEntrada.className = 'btn btn-success btn-lg btn-block mb-3 disabled';
    }
    {% endif %}
    
    {% if ya_registro_salida %}
    if (btnSalida) {
        btnSalida.disabled = true;
        btnSalida.innerHTML = '<i class="fas fa-check"></i><strong>SALIDA REGISTRADA</strong><small class="d-block">Ya registrado hoy</small>';
        btnSalida.className = 'btn btn-danger btn-lg btn-block mb-3 disabled';
    }
    {% endif %}
});
</script>
{% endblock %}