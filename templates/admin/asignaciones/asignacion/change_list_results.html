{% load i18n %}

<script>
// Asegurar que exista el checkbox 'action-toggle' para que actions.js no falle.
(function(){
    try {
        if (!document.getElementById('action-toggle')) {
            var d = document.createElement('div');
            d.className = 'actions';
            d.style.display = 'none';
            d.innerHTML = '<span class="action-counter" data-actions-icnt="0"></span><span class="all"></span><input type="checkbox" id="action-toggle" />';
            document.documentElement.appendChild(d);
        }
    } catch (e) {
        // silencioso
    }
})();
</script>

<style>
    /* Celdas compactas */
    /* Permitir que la tabla tenga un ancho mínimo mayor que su contenedor para
       activar el scroll horizontal en .results. No forzamos width:100% porque
       eso impide el overflow cuando el contenido es más ancho. */
    #result_list {
        width: auto;
        min-width: 1100px; /* ajustar según número de columnas */
        border-collapse: collapse;
        font-size: 13px;
    }

    /* Hacer que el contenedor permita scroll horizontal siempre */
    .results { overflow-x: auto; -webkit-overflow-scrolling: touch; }

    #result_list th, 
    #result_list td {
        border: 1px solid #b6b6b6;
        padding: 8px 10px;
        text-align: left;
        line-height: 1.25;
        white-space: normal; /* permitir wrap para evitar estirar columnas */
        overflow: hidden;
        text-overflow: ellipsis;
        box-sizing: border-box;
        vertical-align: middle;
    }

    /* Headers */
    #result_list th {
        background: #000a46;
        color: #fff;
        font-weight: 600;
        letter-spacing: 0.5px;
        font-size: 12px !important;
        text-align: center !important;
        height: 36px;
        vertical-align: middle;
        padding: 8px 10px;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    #result_list th .text,
    #result_list th .text span {
        white-space: nowrap;
        display: inline-block;
    }

    /* Botones de acción */
    .btn-action {
        border: none;
        border-radius: 4px;
        padding: 4px 14px;
        font-size: 13px;
        font-weight: 500;
        margin-left: 6px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        transition: background 0.2s;
        white-space: nowrap;
    }

    .btn-action.update {
        background: #1976d2;
        color: #fff !important;
    }

    .btn-action.history {
        background: #388e3c;
        color: #fff !important;
    }

    .btn-action.delete {
        background: #d32f2f;
        color: #fff !important;
    }

    .btn-action:hover {
        opacity: 0.85;
        text-decoration: underline;
    }

    /* Filas */
    #result_list tbody tr {
        transition: background 0.2s;
        height: auto;
    }

    #result_list tbody tr:hover {
        background: #eaf6ff;
    }

    /* Links */
    #result_list a {
        color: #1976d2;
        text-decoration: none;
        font-weight: 500;
    }

    #result_list a:hover {
        text-decoration: underline;
    }

    /* Ajustes específicos para móvil */
    @media (max-width: 768px) {
        .results {
            /* Evitar márgenes negativos en móvil para que el scrollbar quede alineado
               con el contenedor del sitio. Usar padding 0 y width 100%. */
            margin: 0;
            width: 100%;
            padding: 0;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* Reducir el min-width de la tabla en móvil para que el scroll sea más razonable */
        #result_list { min-width: 800px; }

        #result_list th,
        #result_list td {
            font-size: 11px;
            padding: 5px 6px;
        }

        #result_list th {
            font-size: 10px !important;
            padding: 6px 8px;
        }

        .btn-action {
            padding: 3px 10px;
            font-size: 11px;
            margin-left: 4px;
        }

        /* Permitir altura automática en filas si es necesario */
        #result_list tbody tr {
            height: auto;
            min-height: 36px;
        }
    }

    /* Para pantallas muy pequeñas */
    @media (max-width: 480px) {
        #result_list th,
        #result_list td {
            font-size: 10px;
            padding: 4px 5px;
        }

        .btn-action {
            padding: 2px 8px;
            font-size: 10px;
        }
    }
</style>

<form id="changelist-form" method="post" novalidate>
    {% csrf_token %}
    <div class="actions" style="display:none;">
        <span class="action-counter" data-actions-icnt="0"></span>
        <span class="all"></span>
        <input type="checkbox" id="action-toggle" />
    </div>
    <div class="results">
    <table id="result_list">
        <thead>
            <tr>
                <th scope="col" class="column-contrato_numero"><div class="text"><span>No. cotización</span></div></th>
                <th scope="col"><div class="text"><span>FECHA</span></div></th>
                <th scope="col"><div class="text"><span>EMPLEADOS</span></div></th>
                     <th scope="col"><div class="text"><span>EMPRESA</span></div></th>
                <th scope="col"><div class="text"><span>SUPERVISOR</span></div></th>
                <th scope="col"><div class="text"><span>DETALLES</span></div></th>
                <th scope="col"><div class="text"><span>DOCUMENTO</span></div></th>
                <th scope="col"><div class="text"><span>DÍAS ACTIVOS</span></div></th>
                <th scope="col"><div class="text"><span>FECHA TÉRMINO</span></div></th>
                <th scope="col"><div class="text"><span># ACT</span></div></th>
                <th scope="col"><div class="text"><span>HISTORIAL</span></div></th>
                <th scope="col"><div class="text"><span>ACCIONES</span></div></th>
            </tr>
        </thead>
        <tbody>
            {% for obj in cl.result_list %}
            <tr>
                <td class="column-contrato_numero">{{ obj.numero_cotizacion|default:'-' }}</td>
                <td>{{ obj.fecha|date:"d/m/Y" }}</td>
                <td style="text-align:center">{{ obj.empleados.count }}</td>
                <td>{{ obj.empresa }}</td>
                <td>{{ obj.supervisor.nombre_primer_apellido|default:'-' }}</td>
                <td>{{ obj.detalles }}</td>
                <td>
                    {% if obj.archivos and obj.numero_cotizacion %}
                        <a href="{{ obj.archivos.url }}" target="_blank">Doc-{{ obj.numero_cotizacion }}{% if obj.archivo_extension %}.{{ obj.archivo_extension }}{% endif %}</a>
                    {% elif obj.archivos %}
                        <a href="{{ obj.archivos.url }}" target="_blank">Doc-{{ obj.numero_cotizacion|default:'-' }}{% if obj.archivo_extension %}.{{ obj.archivo_extension }}{% endif %}</a>
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td style="text-align:center">{{ obj.dias_trabajados.count }}</td>
                <td style="text-align:center">{% if obj.fecha_termino %}{{ obj.fecha_termino|date:"d/m/Y" }}{% endif %}</td>
                <td style="text-align:center;">{{ obj.actividades_total }}</td>
                <td style="text-align:center;">
                    <a href="{% url 'admin:asignaciones_asignacion_historial' obj.pk %}" class="btn-action history">Historial</a>
                </td>
                <td style="text-align:right;">
                    <a href="{{ obj.get_admin_url }}" class="btn-action update">Actualizar</a>
                    <a href="{% url 'admin:asignaciones_asignacion_delete' obj.pk %}" class="btn-action delete">Eliminar</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    </div>
</form>